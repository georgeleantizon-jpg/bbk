<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuoBuo Ka Pre-Order Form</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10b981', /* Emerald for a fresh, commerce feel */
                        'primary-dark': '#059669',
                        'background': '#f9fafb',
                        'card': '#ffffff',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-background min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app-container" class="w-full max-w-md bg-card shadow-2xl rounded-xl p-8 space-y-6 transform transition duration-300 border border-gray-100">
        
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Place Your Pre-Order</h1>
        <p class="text-center text-sm text-gray-500">
            Securely reserve your item. Your unique customer ID will be attached to this order.
        </p>

        <!-- Form Inputs -->
        <div class="space-y-4">
            <div>
                <label for="customer-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="customer-name" placeholder="John Doe" 
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm" required />
            </div>
            <div>
                <label for="customer-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="customer-email" placeholder="john@example.com" 
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm" required />
            </div>
            <div>
                <label for="item-name" class="block text-sm font-medium text-gray-700">Item to Pre-Order</label>
                <select id="item-name" 
                        class="mt-1 w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm">
                    <option value="Product X">Product X (Premium)</option>
                    <option value="Product Y">Product Y (Standard)</option>
                    <option value="Service Z">Service Z (Consultation)</option>
                </select>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="quantity" value="1" min="1" 
                           class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm" required />
                </div>
            </div>

            <!-- Status Message Display -->
            <div id="status-message" class="text-center h-6 text-sm font-medium">
                 Initializing connection...
            </div>

            <button onclick="submitPreOrder()" id="submit-button" disabled
                    class="w-full py-3 px-4 bg-primary text-white font-semibold rounded-lg shadow-lg hover:bg-primary-dark transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]">
                Submit Pre-Order
            </button>
        </div>
        
    </div>

    <!-- Firebase Initialization and Application Logic -->
    <script type="module">
        // ----------------------------------------------------------------------
        // 1. FIREBASE IMPORTS
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firebase debug logging
        setLogLevel('Debug');

        // ----------------------------------------------------------------------
        // 2. GLOBAL STATE AND INITIALIZATION
        // ----------------------------------------------------------------------
        let db;
        let auth;
        let userId = null; // The unique customer ID we'll attach to the order

        const statusMessageEl = document.getElementById('status-message');
        const submitButtonEl = document.getElementById('submit-button');
        
        // Form element references
        const nameEl = document.getElementById('customer-name');
        const emailEl = document.getElementById('customer-email');
        const itemEl = document.getElementById('item-name');
        const quantityEl = document.getElementById('quantity');
        
        // ----------------------------------------------------------------------
        // *** CONFIGURATION: USING YOUR PROVIDED FIREBASE DETAILS ***
        // ----------------------------------------------------------------------
        const userProvidedConfig = {
            apiKey: "AIzaSyAY2GPRaHbU7vfA8J79mewyo2u6qHr-a6s",
            authDomain: "buobuo-ka-81320.firebaseapp.com",
            projectId: "buobuo-ka-81320",
            storageBucket: "buobuo-ka-81320.firebasestorage.app",
            messagingSenderId: "687871046289",
            appId: "1:687871046289:web:e8efb15aa500add7164530",
            measurementId: "G-S2XMMG6P9W"
        };

        // Use the globally provided config as a fallback/check, but prioritize the explicit config here.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("Firebase config is critically missing.");
            statusMessageEl.textContent = "Critical Error: Configuration Missing.";
        } else {
            initializeFirebase();
        }

        async function initializeFirebase() {
            try {
                // Initialize the Firebase App
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 3. AUTHENTICATION SETUP (Silent Sign-in)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 4. AUTH STATE CHANGE LISTENER
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is now signed in (anonymously or via custom token)
                        userId = user.uid;
                        submitButtonEl.disabled = false;
                        submitButtonEl.textContent = "Submit Pre-Order";
                        console.log(`Unique Customer ID: ${userId}`);
                        statusMessageEl.textContent = "Database Connected. Ready to take order.";
                        statusMessageEl.classList.remove('text-red-500');
                        statusMessageEl.classList.add('text-primary-dark');
                    } else {
                        userId = null;
                        submitButtonEl.disabled = true;
                        submitButtonEl.textContent = "Authentication Failed";
                        statusMessageEl.textContent = "Failed to secure customer identity.";
                        statusMessageEl.classList.add('text-red-500');
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                statusMessageEl.textContent = `Initialization Error: ${error.code || 'Unknown'}`;
                statusMessageEl.classList.add('text-red-500');
            }
        }

        // 5. FIRESTORE SUBMISSION FUNCTION (Exposed globally)
        window.submitPreOrder = async function() {
            if (!userId) {
                console.error("Authentication not complete. Cannot submit.");
                statusMessageEl.textContent = "Please wait for connection...";
                return;
            }

            const name = nameEl.value.trim();
            const email = emailEl.value.trim();
            const item = itemEl.value;
            const quantity = parseInt(quantityEl.value, 10);
            
            // Basic Form Validation
            if (!name || !email || quantity < 1 || isNaN(quantity)) {
                statusMessageEl.textContent = "Please fill in all fields correctly.";
                statusMessageEl.classList.add('text-red-500');
                return;
            }

            submitButtonEl.disabled = true;
            submitButtonEl.textContent = "Processing Order...";
            statusMessageEl.textContent = "";
            statusMessageEl.classList.remove('text-red-500', 'text-primary-dark');

            try {
                // Path: /artifacts/{appId}/users/{userId}/preorders
                // NOTE: Orders are saved under the user's private path for this application.
                const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/preorders`);

                await addDoc(ordersCollectionRef, {
                    customerName: name,
                    customerEmail: email,
                    itemName: item,
                    quantity: quantity,
                    customerUserId: userId, // Incorporating the unique ID as requested
                    status: 'PENDING',
                    timestamp: serverTimestamp(),
                });
                
                // Success feedback
                statusMessageEl.textContent = "Pre-Order submitted successfully! We'll contact you soon.";
                statusMessageEl.classList.remove('text-red-500');
                statusMessageEl.classList.add('text-primary-dark');

                // Clear form
                nameEl.value = '';
                emailEl.value = '';
                quantityEl.value = '1';

                console.log(`Order saved for user ${userId} in collection: ${ordersCollectionRef.path}`);

            } catch (error) {
                console.error("Error submitting pre-order:", error);
                // Display error to the user
                statusMessageEl.textContent = `Order Failed: ${error.code || 'Unknown Error'}. Check Firestore rules.`;
                statusMessageEl.classList.add('text-red-500');
            } finally {
                submitButtonEl.textContent = "Submit Pre-Order";
                submitButtonEl.disabled = false;
            }
        };

    </script>
</body>
</html>
