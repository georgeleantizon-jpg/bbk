<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BuoBuo Ka - Pre-Order System</title>
  <script src="config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
    .container-card { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
    .btn-primary { transition: all 0.2s ease-in-out; background-color: #3b82f6; color: white; box-shadow: 0 4px 6px rgba(59,130,246,0.2); }
    .btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
    .dashboard-table-header { background-color: #eef2ff; color: #374151; }
    .dashboard-table-row:nth-child(even) { background-color: #f9fafb; }
    .pin-input { letter-spacing: 10px; text-align: center; }
  </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
  <div id="app" class="w-full max-w-6xl bg-white rounded-xl container-card p-6 md:p-10 my-8">
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">BuoBuo Ka Pre-Order</h1>
      <h2 class="text-xl font-medium text-blue-600 mt-1">A Product by Team A.N.G. A. Co.</h2>
      <div class="mt-4 flex justify-center space-x-4">
        <button id="nav-order-builder" onclick="window.app.selectStep('mode_selection')" class="text-lg font-semibold px-4 py-2 rounded-lg transition-colors bg-blue-100 text-blue-800 hover:bg-blue-200">üõçÔ∏è Order Builder</button>
        <button id="nav-manager-dashboard" onclick="window.app.renderOrderDashboard()" class="text-lg font-semibold px-4 py-2 rounded-lg transition-colors text-gray-600 hover:bg-gray-100">üìä Manager Dashboard</button>
      </div>
    </header>

    <!-- Dynamic Content Area -->
    <div id="content-area"></div>
    <p id="auth-info" class="text-xs text-center text-gray-400 mt-8">Authentication Status: Connecting to database...</p>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, onSnapshot, query, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let db = null, auth = null, userId = 'anon-user', dbStatus = 'connecting';
    let firebaseConfig = null;

    try {
      if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
      } else throw new Error("Missing Firebase config");
    } catch (e) {
      dbStatus = 'config_missing';
    }

    const APP_CONTAINER = document.getElementById('content-area');
    const authInfoEl = document.getElementById('auth-info');
    const MANAGER_KEY = "1234";

    // --- APP STATE ---
    let currentStep = 'mode_selection';
    let orderData = {
      items: [],
      addOns: {},
      name: '',
      fbLink: '',
      phone: '',
      gradeSection: '',
      customization: { dimension: null, photoFileName: null, price: 0 },
      calculations: { subtotal: 0, discount: 0, addOnTotal: 0, finalTotal: 0 },
      timestamp: new Date().toISOString()
    };

    // --- FIREBASE INIT ---
    function initializeFirebase() {
      if (!firebaseConfig) return;
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      onAuthStateChanged(auth, (user) => {
        if (user) { userId = user.uid; setAuthStatus('ready'); }
      });
      signInAnonymously(auth).catch(e => setAuthStatus('auth_failed', e.message));
    }

    function setAuthStatus(status, msg='') {
      dbStatus = status;
      if (status === 'ready') authInfoEl.innerHTML = `<p class="text-green-600">‚úÖ Database Connected</p>`;
      else if (status === 'config_missing') authInfoEl.innerHTML = `<p class="text-red-600">‚ùå Config Missing</p>`;
      else if (status === 'auth_failed') authInfoEl.innerHTML = `<p class="text-red-600">‚ùå Auth Failed: ${msg}</p>`;
      else authInfoEl.innerHTML = `<p class="text-gray-400">Connecting...</p>`;
    }

    // --- STEP 3: DETAILS FORM ---
    function renderDetailsForm() {
      APP_CONTAINER.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <h3 class="text-2xl font-semibold mb-8 text-gray-800">Step 3: Contact & Delivery Details</h3>
            <form id="details-form" onsubmit="event.preventDefault(); window.app.selectStep('confirmation')">
              <div class="space-y-6 bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" value="${orderData.name}" required oninput="orderData.name=this.value" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">FB Profile Link</label>
                    <input type="url" value="${orderData.fbLink}" required oninput="orderData.fbLink=this.value" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" value="${orderData.phone}" required oninput="orderData.phone=this.value" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Grade Level & Section</label>
                    <input type="text" value="${orderData.gradeSection}" required oninput="orderData.gradeSection=this.value" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                </div>
              </div>
              <button type="submit" class="mt-6 btn-primary px-6 py-3 rounded-lg font-semibold w-full text-lg">Review & Confirm Order ‚Üí</button>
            </form>
          </div>
          <div class="lg:col-span-1">
            <div id="order-summary-container"></div>
          </div>
        </div>
      `;
      currentStep = 'details';
    }

    // --- STEP 4: CONFIRMATION ---
    function renderConfirmation() {
      APP_CONTAINER.innerHTML = `
        <h3 class="text-2xl font-semibold text-center mb-8 text-gray-800">Step 4: Confirm Your Order</h3>
        <div class="max-w-3xl mx-auto">
          <div class="bg-gray-50 p-6 rounded-xl space-y-4 mb-8 border">
            <p class="text-lg font-bold">Contact & Order Details:</p>
            <p><strong>Name:</strong> ${orderData.name}</p>
            <p><strong>FB Profile:</strong> <a href="${orderData.fbLink}" target="_blank" class="text-blue-600">${orderData.fbLink}</a></p>
            <p><strong>Phone:</strong> ${orderData.phone}</p>
            <p><strong>Grade & Section:</strong> ${orderData.gradeSection}</p>
          </div>
          <button onclick="window.app.submitOrder()" class="btn-primary px-6 py-4 rounded-lg font-bold w-full text-xl shadow-lg hover:shadow-xl">Submit Pre-Order</button>
        </div>
      `;
      currentStep = 'confirmation';
    }

    // --- SUBMIT TO FIRESTORE ---
    async function submitOrder() {
      if (!db) return;
      const collectionPath = `artifacts/buobuo-ka-orders/users/${userId}/orders`;
      await addDoc(collection(db, collectionPath), { ...orderData, delivered: false, timestamp: new Date().toISOString() });
      alert("‚úÖ Order submitted!");
      orderData = { items: [], addOns: {}, name: '', fbLink: '', phone: '', gradeSection: '', customization: {}, calculations: {}, timestamp: new Date().toISOString() };
      renderDetailsForm();
    }

    // --- MANAGER DASHBOARD ---
    function renderOrderDashboard() {
      APP_CONTAINER.innerHTML = `
        <h3 class="text-2xl font-semibold mb-6 text-gray-800 text-center">üìä Manager Dashboard</h3>
        <div id="dashboard-content" class="bg-white rounded-xl shadow-inner p-4 overflow-x-auto min-h-[300px]"></div>
        <div class="mt-4 text-right">
          <button onclick="window.app.exportOrdersToCSV()" class="btn-primary px-4 py-2 rounded-lg font-semibold shadow">‚¨áÔ∏è Export CSV</button>
        </div>
      `;
      listenForOrders();
    }

    let latestOrders = [];
    function listenForOrders() {
      const q = query(collection(db, `artifacts/buobuo-ka-orders/users/${userId}/orders`));
      onSnapshot(q, (snapshot) => {
        const orders = [];
        snapshot.forEach(docSnap => orders.push({ id: docSnap.id, ...docSnap.data() }));
        latestOrders = orders;
        displayOrders(orders);
      });
    }

    function displayOrders(orders) {
      const dashboardContent = document.getElementById('dashboard-content');
      if (orders.length === 0) { dashboardContent.innerHTML = "No orders yet."; return; }
      dashboardContent.innerHTML = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="dashboard-table-header">
            <tr>
              <th class="px-3 py-3">Name</th>
              <th class="px-3 py-3">Phone</th>
              <th class="px-3 py-3">Grade & Section</th>
              <th class="px-3 py-3">FB Profile</th>
              <th class="px-3 py-3">Delivered</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(o => `
              <tr>
                <td class="px-3 py-2">${o.name}</td>
                <td class="px-3 py-2">${o.phone}</td>
                <td class="px-3 py-2">${o.gradeSection}</td>
                <td class="px-3 py-2"><a href="${o.fbLink}" class="text-blue-600" target="_blank">Profile</a></td>
                <td class="px-3 py-2 text-center">
                  <input type="checkbox" ${o.delivered ? "checked" : ""} onchange="window.app.toggleDelivered('${o.id}', this.checked)">
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      `;
    }

    function exportOrdersToCSV() {
      if (latestOrders.length === 0) return alert("No orders.");
      const headers = ["Name","Phone","Grade & Section","FB Profile","Delivered"];
      const rows = latestOrders.map(o => [o.name, o.phone, o.gradeSection, o.fbLink, o.delivered ? "Yes":"No"]);
      const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download="orders.csv"; a.click();
    }

    async function toggleDelivered(orderId, delivered) {
      const ref = doc(db, `artifacts/buobuo-ka-orders/users/${userId}/orders/${orderId}`);
      await setDoc(ref, { delivered }, { merge: true });
    }

    // --- NAVIGATION ---
    function selectStep(step) { if (step==="details") renderDetailsForm(); else if (step==="confirmation") renderConfirmation(); }
    window.onload = () => { initializeFirebase(); renderDetailsForm(); }

    window.app = { selectStep, renderDetailsForm, renderOrderDashboard, submitOrder, exportOrdersToCSV, toggleDelivered };
  </script>
</body>
</html>
