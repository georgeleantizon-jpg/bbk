<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Real-Time Message Sync</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#4338ca',
                        'background': '#f3f4f6',
                        'card': '#ffffff',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-background min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app-container" class="w-full max-w-lg bg-card shadow-2xl rounded-xl p-8 space-y-6 transform transition duration-300">
        
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Real-Time Message Sync</h1>
        <p class="text-center text-sm text-gray-500">
            Uses Firestore to sync a message across all users instantly.
        </p>

        <!-- Status and User ID Display -->
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
            <p id="auth-status" class="text-sm font-medium text-indigo-700">
                Authentication Status: <span class="font-bold">Initializing...</span>
            </p>
            <p id="user-id-display" class="text-xs text-indigo-500 truncate mt-1">
                User ID: N/A
            </p>
        </div>

        <!-- Current Message Display -->
        <div class="bg-gray-50 p-6 rounded-xl border-2 border-dashed border-gray-300 min-h-[8rem] flex items-center justify-center transition duration-200 hover:border-primary-dark">
            <p id="realtime-message" class="text-2xl font-bold text-gray-800 text-center italic">
                Awaiting connection...
            </p>
        </div>

        <!-- Input and Update Button -->
        <div class="space-y-4">
            <input type="text" id="new-message-input" placeholder="Type a new real-time message..." 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm" />

            <button onclick="updateMessage()" id="update-button" disabled
                    class="w-full py-3 px-4 bg-primary text-white font-semibold rounded-lg shadow-lg hover:bg-primary-dark transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]">
                Update Shared Message
            </button>
        </div>

    </div>

    <!-- Firebase Initialization and Application Logic -->
    <script type="module">
        // ----------------------------------------------------------------------
        // 1. FIREBASE IMPORTS
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firebase debug logging
        setLogLevel('Debug');

        // ----------------------------------------------------------------------
        // 2. GLOBAL STATE AND INITIALIZATION
        // ----------------------------------------------------------------------
        let db;
        let auth;
        let userId = null;
        let messageDocRef = null;

        const authStatusEl = document.getElementById('auth-status').querySelector('span');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const messageEl = document.getElementById('realtime-message');
        const inputEl = document.getElementById('new-message-input');
        const updateButtonEl = document.getElementById('update-button');
        
        // Use the globally provided configuration and application ID
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseConfig) {
            console.error("Firebase config is missing. Cannot initialize Firebase.");
            authStatusEl.textContent = "Error: Config Missing";
            authStatusEl.classList.add('text-red-700');
        } else {
            initializeFirebase();
        }

        async function initializeFirebase() {
            try {
                // Initialize the Firebase App
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 3. AUTHENTICATION SETUP
                // Use custom token if provided, otherwise sign in anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 4. AUTH STATE CHANGE LISTENER
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = "Connected";
                        authStatusEl.classList.remove('text-indigo-700');
                        authStatusEl.classList.add('text-green-700');
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        updateButtonEl.disabled = false;
                        
                        // Proceed to Firestore setup only after successful authentication
                        setupFirestoreListener();
                    } else {
                        userId = null;
                        authStatusEl.textContent = "Signed Out";
                        authStatusEl.classList.remove('text-green-700');
                        authStatusEl.classList.add('text-red-700');
                        userIdDisplayEl.textContent = "User ID: N/A";
                        updateButtonEl.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                authStatusEl.textContent = `Error: ${error.code || 'Unknown'}`;
                authStatusEl.classList.remove('text-indigo-700');
                authStatusEl.classList.add('text-red-700');
            }
        }

        // 5. FIRESTORE REAL-TIME LISTENER
        function setupFirestoreListener() {
            // Path: /artifacts/{appId}/public/data/messages/shared_message
            const collectionPath = `artifacts/${appId}/public/data/messages`;
            messageDocRef = doc(db, collectionPath, 'shared_message');

            // Set up a real-time listener for the document
            onSnapshot(messageDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    const messageText = data.text || "No message set yet.";
                    const updatedBy = data.lastUpdatedBy || "System";
                    
                    messageEl.innerHTML = `"${messageText}" <br><span class="text-sm font-normal text-gray-500">- Last updated by: ${updatedBy.substring(0, 8)}...</span>`;
                    inputEl.value = data.text || ''; // Keep input synced
                } else {
                    // Initialize the document if it doesn't exist
                    messageEl.textContent = "Initializing shared message...";
                    setDoc(messageDocRef, { 
                        text: "Welcome! Be the first to update the message.", 
                        timestamp: serverTimestamp(),
                        lastUpdatedBy: 'System'
                    }, { merge: true }).catch(e => console.error("Error initializing document:", e));
                }
            }, (error) => {
                console.error("Error listening to message document:", error);
                messageEl.textContent = "Error loading message data.";
                messageEl.classList.add('text-red-500');
            });
        }

        // 6. FIRESTORE UPDATE FUNCTION (Exposed globally)
        window.updateMessage = async function() {
            if (!messageDocRef || !userId) {
                console.error("Firestore or Auth not initialized.");
                return;
            }

            const newMessage = inputEl.value.trim();
            if (newMessage === "") {
                inputEl.placeholder = "Message cannot be empty!";
                inputEl.classList.add('border-red-500');
                setTimeout(() => {
                    inputEl.classList.remove('border-red-500');
                    inputEl.placeholder = "Type a new real-time message...";
                }, 2000);
                return;
            }

            updateButtonEl.disabled = true;
            updateButtonEl.textContent = "Updating...";

            try {
                await updateDoc(messageDocRef, {
                    text: newMessage,
                    timestamp: serverTimestamp(),
                    lastUpdatedBy: userId,
                });
                console.log("Message successfully updated!");
            } catch (error) {
                console.error("Error updating document:", error);
                // Display error to the user
                messageEl.textContent = `Update Failed: ${error.code || 'Unknown Error'}`;
            } finally {
                updateButtonEl.textContent = "Update Shared Message";
                updateButtonEl.disabled = false;
            }
        };

    </script>
</body>
</html>
